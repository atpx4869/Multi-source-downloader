name: Build MultiSourceDownloader v4.0

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  VERSION: "4.0.0"

jobs:
  build-nuitka-win10:
    name: "Build Win10+ (Python 3.11 + Nuitka)"
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install nuitka ordered-set zstandard
      shell: pwsh
    
    - name: Create auth cache
      run: |
        if (-not (Test-Path "app/.auth_cache")) {
          New-Item -Path "app/.auth_cache" -ItemType File -Force | Out-Null
          Write-Host "Created .auth_cache"
        }
      shell: pwsh
    
    - name: Convert icon
      run: |
        python -c "from PIL import Image; img = Image.open('core/logo.png'); img.save('app.ico', format='ICO', sizes=[(256,256)]); print('Icon converted')"
      shell: pwsh
    
    - name: Compile with Nuitka
      run: |
        Write-Host "Starting Nuitka compilation..." -ForegroundColor Cyan
        python -m nuitka --onefile --standalone `
          --windows-console-mode=disable `
          --enable-plugin=pyside6 `
          --windows-icon-from-ico=app.ico `
          --include-data-file=core/logo.png=core/logo.png `
          --include-data-file=app/.auth_cache=app/.auth_cache `
          --assume-yes-for-downloads `
          --output-dir=dist `
          --output-filename=MultiSourceDownloader.exe `
          desktop_app.py
        Write-Host "Nuitka compilation completed" -ForegroundColor Green
      shell: pwsh
    
    - name: Get build info
      id: build_info
      run: |
        $date = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $exe = Get-Item dist/MultiSourceDownloader.exe
        $sizeMB = [math]::Round($exe.Length / 1MB, 2)
        echo "date=$date" >> $env:GITHUB_OUTPUT
        echo "size=$sizeMB" >> $env:GITHUB_OUTPUT
        Write-Host "File size: $sizeMB MB" -ForegroundColor Cyan
      shell: pwsh
    
    - name: Create version file
      env:
        BUILD_DATE: ${{ steps.build_info.outputs.date }}
        BUILD_SIZE: ${{ steps.build_info.outputs.size }}
      run: |
        echo "# MultiSourceDownloader v4.0 - Nuitka" > dist/VERSION_4.0.md
        echo "" >> dist/VERSION_4.0.md
        echo "## Build Info" >> dist/VERSION_4.0.md
        echo "- Build Date: $env:BUILD_DATE" >> dist/VERSION_4.0.md
        echo "- File Size: $env:BUILD_SIZE MB" >> dist/VERSION_4.0.md
        echo "- Compiler: Nuitka (Native)" >> dist/VERSION_4.0.md
        echo "- Python: 3.11" >> dist/VERSION_4.0.md
        echo "- OS: Windows 10+" >> dist/VERSION_4.0.md
        echo "" >> dist/VERSION_4.0.md
        echo "## Features" >> dist/VERSION_4.0.md
        echo "- Fast startup: 1-2 seconds" >> dist/VERSION_4.0.md
        echo "- Native C speed" >> dist/VERSION_4.0.md
        echo "- Full UTF-8 and Emoji support" >> dist/VERSION_4.0.md
        echo "- Optimized size (30-40% smaller)" >> dist/VERSION_4.0.md
      shell: pwsh
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MultiSourceDownloader-v4.0-Nuitka-win64
        path: |
          dist/MultiSourceDownloader.exe
          dist/VERSION_4.0.md
        retention-days: 90
    
    - name: Show completion
      run: |
        Write-Host ""
        Write-Host "Build completed successfully!" -ForegroundColor Green
        Write-Host "File: MultiSourceDownloader.exe" -ForegroundColor White
        Write-Host "Size: ${{ steps.build_info.outputs.size }} MB" -ForegroundColor White
        Write-Host ""
      shell: pwsh

  build-nuitka-win7:
    name: "Build Win7 (Python 3.8 + Nuitka)"
    runs-on: windows-2019
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python 3.8
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_win7.txt
        pip install nuitka ordered-set zstandard
      shell: pwsh
    
    - name: Create auth cache
      run: |
        if (-not (Test-Path "app/.auth_cache")) {
          New-Item -Path "app/.auth_cache" -ItemType File -Force | Out-Null
          Write-Host "Created .auth_cache"
        }
      shell: pwsh
    
    - name: Convert icon
      run: |
        python -c "from PIL import Image; img = Image.open('core/logo.png'); img.save('app.ico', format='ICO', sizes=[(256,256)]); print('Icon converted')"
      shell: pwsh
    
    - name: Compile with Nuitka
      run: |
        Write-Host "Starting Nuitka compilation (Win7)..." -ForegroundColor Cyan
        python -m nuitka --onefile --standalone `
          --windows-console-mode=disable `
          --enable-plugin=pyside2 `
          --windows-icon-from-ico=app.ico `
          --include-data-file=core/logo.png=core/logo.png `
          --include-data-file=app/.auth_cache=app/.auth_cache `
          --assume-yes-for-downloads `
          --output-dir=dist `
          --output-filename=MultiSourceDownloader-Win7.exe `
          desktop_app.py
        Write-Host "Nuitka compilation completed" -ForegroundColor Green
      shell: pwsh
    
    - name: Get build info
      id: build_info_win7
      run: |
        $date = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $exe = Get-Item dist/MultiSourceDownloader-Win7.exe
        $sizeMB = [math]::Round($exe.Length / 1MB, 2)
        echo "date=$date" >> $env:GITHUB_OUTPUT
        echo "size=$sizeMB" >> $env:GITHUB_OUTPUT
        Write-Host "File size: $sizeMB MB" -ForegroundColor Cyan
      shell: pwsh
    
    - name: Create version file
      env:
        BUILD_DATE: ${{ steps.build_info_win7.outputs.date }}
        BUILD_SIZE: ${{ steps.build_info_win7.outputs.size }}
      run: |
        echo "# MultiSourceDownloader v4.0 - Win7" > dist/VERSION_4.0_Win7.md
        echo "" >> dist/VERSION_4.0_Win7.md
        echo "## Build Info" >> dist/VERSION_4.0_Win7.md
        echo "- Build Date: $env:BUILD_DATE" >> dist/VERSION_4.0_Win7.md
        echo "- File Size: $env:BUILD_SIZE MB" >> dist/VERSION_4.0_Win7.md
        echo "- Compiler: Nuitka (Native)" >> dist/VERSION_4.0_Win7.md
        echo "- Python: 3.8" >> dist/VERSION_4.0_Win7.md
        echo "- UI: PySide2" >> dist/VERSION_4.0_Win7.md
        echo "- OS: Windows 7+" >> dist/VERSION_4.0_Win7.md
        echo "" >> dist/VERSION_4.0_Win7.md
        echo "## Features" >> dist/VERSION_4.0_Win7.md
        echo "- Fast startup: 1-2 seconds" >> dist/VERSION_4.0_Win7.md
        echo "- Native C speed" >> dist/VERSION_4.0_Win7.md
        echo "- Full UTF-8 and Emoji support" >> dist/VERSION_4.0_Win7.md
        echo "- Compatible with Win7/8/10/11" >> dist/VERSION_4.0_Win7.md
      shell: pwsh
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MultiSourceDownloader-v4.0-Win7-Nuitka
        path: |
          dist/MultiSourceDownloader-Win7.exe
          dist/VERSION_4.0_Win7.md
        retention-days: 90
    
    - name: Show completion
      run: |
        Write-Host ""
        Write-Host "Win7 build completed successfully!" -ForegroundColor Green
        Write-Host "File: MultiSourceDownloader-Win7.exe" -ForegroundColor White
        Write-Host "Size: ${{ steps.build_info_win7.outputs.size }} MB" -ForegroundColor White
        Write-Host ""
      shell: pwsh
